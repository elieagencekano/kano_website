---
interface Project {
  id: string;
  name: string;
  description: string;
  video: string;
}

interface Props {
  projects?: Project[];
}

const { projects } = Astro.props as Props;
const list = projects && projects.length
  ? projects
  : [
      { id: "1", name: "Domaine Didier Delaunay", description: "Site vitrine viticole", video: "Delaunay-Home.mp4" },
      { id: "2", name: "Actiba Menuiseries", description: "Site e-commerce menuiserie", video: "Actiba-Home.mp4" },
      { id: "3", name: "Pro2mat", description: "Site vitrine industriel", video: "Home-Pro2mat.mp4" }
    ];
---

<section class="projects-carousel" aria-label="Réalisations">
  <div class="container-projects">
    <div class="header-projects">
      <h2>Nos réalisations</h2>
      <p class="intro-projects">Découvrez nos derniers projets en direct, conçus pour être en 1ère page sur Google.</p>
    </div>

    <div class="carousel-wrapper">
      <div class="carousel-container">
        <div class="projects-slider">
          {list.map((project, idx) => (
            <div class="carousel-item" data-id={project.id} data-index={idx}>
              <div class="project-card glass">
                <div class="window-header">
                  <div class="window-buttons">
                    <span class="btn red"></span>
                    <span class="btn yellow"></span>
                    <span class="btn green"></span>
                  </div>
                  <span class="window-url">{project.name}</span>
                </div>
                <div class="window-frame">
                  <video
                    class="project-video"
                    data-src={`/${project.video}`}
                    loop
                    muted
                    playsinline
                    preload="none"
                  ></video>
                </div>
              </div>
              <div class="project-details">
                <h3 class="project-name">{project.name}</h3>
                <p class="project-desc">{project.description}</p>
              </div>
            </div>
          ))}
        </div>

        <button class="carousel-btn prev" aria-label="Précédent">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <button class="carousel-btn next" aria-label="Suivant">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

      <div class="carousel-dots">
        {list.map((_, idx) => (
          <button class="dot" data-index={idx} aria-label={`Projet ${idx + 1}`}></button>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  .projects-carousel { position: relative; padding: 100px 0; overflow: visible; z-index: 200; }
  .container-projects { max-width: 1280px; margin: 0 auto; padding: 0 32px; overflow: visible; position: relative; z-index: 200; }
  .header-projects { text-align: center; max-width: 700px; margin: 0 auto 80px; animation: fadeUp 700ms ease-out; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .header-projects h2 { font-size: clamp(2rem, 3.5vw, 3rem); margin: 0 0 16px; background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.85) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: Montserrat, sans-serif; }
  .intro-projects { font-size: 1.15rem; color: var(--kano-light); opacity: 0.88; line-height: 1.6; margin: 0; }

  .glass { background: rgba(255, 255, 255, 0.06); border: none; backdrop-filter: blur(12px) saturate(120%); -webkit-backdrop-filter: blur(12px) saturate(120%); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); }

  .carousel-wrapper { animation: scaleUp 800ms ease-out 0.2s backwards; overflow: visible; }
  @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

  .carousel-container { position: relative; width: 100%; min-height: 500px; overflow: visible; }

  .projects-slider { position: relative; height: 560px; overflow: visible; }

  .carousel-item { position: absolute; top: 0; left: 50%; width: min(70vw, 900px); transform: translateX(-50%); display: flex; flex-direction: column; gap: 20px; transition: transform .7s cubic-bezier(.22,.61,.36,1), filter .7s cubic-bezier(.22,.61,.36,1), opacity .7s cubic-bezier(.22,.61,.36,1); will-change: transform, filter, opacity; z-index: 10; }
  .carousel-item.is-active { transform: translateX(-50%) scale(1); filter: none; opacity: 1; z-index: 100; }
  .carousel-item.is-right { --gap: 96px; --idx: 1; transform: translateX(calc(-50% + var(--idx) * var(--gap))) scale(calc(1 - var(--idx) * 0.08)); filter: blur(calc(2px + (var(--idx) - 1) * 1px)); opacity: calc(0.9 - var(--idx) * 0.12); z-index: calc(99 - var(--idx)); pointer-events: none; }
  .carousel-item.is-left { transform: translateX(calc(-50% - 40vw)) scale(0.9); opacity: 0; filter: blur(6px); z-index: 1; pointer-events: none; }

  .project-card { width: 100%; aspect-ratio: 1901 / 943; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; background: rgba(15, 20, 25, 0.95); position: relative; }

  .window-header { height: 36px; position: relative; z-index: 20; background: rgba(8,12,18,0.28); backdrop-filter: saturate(120%) blur(14px); -webkit-backdrop-filter: saturate(120%) blur(14px); display: flex; align-items: center; justify-content: center; gap: 12px; padding: 0 14px; flex-shrink: 0; overflow: visible; }
  .window-header::after { content: ""; position: absolute; inset: 0; z-index: 0; background: linear-gradient(to bottom, rgba(255,255,255,0.08), rgba(255,255,255,0.02) 45%, rgba(0,0,0,0.2) 100%); pointer-events: none; }
  .window-buttons { display: flex; gap: 8px; position: absolute; left: 14px; z-index: 1; }
  .btn { width: 12px; height: 12px; border-radius: 50%; display: block; }
  .btn.red { background: #ff5f57; }
  .btn.yellow { background: #febc2e; }
  .btn.green { background: #28c840; }
  .window-url { position: relative; z-index: 1; font-family: Poppins, sans-serif; font-size: 12px; color: rgba(255, 255, 255, 0.7); text-align: center; }

  .window-frame { flex: 1; position: relative; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); overflow: hidden; }

  .project-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; }

  .project-details { display: flex; flex-direction: column; gap: 8px; }
  .project-name { font-size: 1.1rem; font-weight: 800; color: #fff; margin: 0; font-family: Montserrat, sans-serif; }
  .project-desc { font-size: 0.9rem; color: var(--kano-light); opacity: 0.8; line-height: 1.5; margin: 0; }

  .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; background: rgba(212, 175, 55, 0.15); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 50%; color: var(--kano-gold); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 120; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
  .carousel-btn:hover { background: rgba(212, 175, 55, 0.25); border-color: rgba(212, 175, 55, 0.5); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); transform: translateY(-50%) scale(1.05); }
  .carousel-btn.prev { left: 12px; }
  .carousel-btn.next { right: 12px; }

  .carousel-dots { display: flex; justify-content: center; gap: 8px; margin-top: 40px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .dot.active { background: var(--kano-gold); }

  @media (max-width: 1024px) {
    .carousel-item { width: min(80vw, 720px); }
    .projects-slider { height: 480px; }
    .carousel-btn.prev { left: 8px; }
    .carousel-btn.next { right: 8px; }
  }

  @media (max-width: 768px) and (min-width: 481px) {
    .projects-carousel { padding: 80px 0; }
    .container-projects { padding: 0 20px; }
    .header-projects { margin-bottom: 60px; }
    .projects-slider { height: 360px; }
    .carousel-item { width: calc(100vw - 40px); gap: 12px; }
    .project-card { aspect-ratio: 16 / 10; border-radius: 16px; }
    .project-video { object-fit: contain; }
    .carousel-btn { width: 36px; height: 36px; top: 160px; transform: translateY(-50%); }
    .carousel-btn.prev { left: 6px; }
    .carousel-btn.next { right: 6px; }
    .project-name { font-size: 1rem; }
    .project-desc { font-size: 0.85rem; }
    .carousel-dots { gap: 6px; margin-top: 6px; }
    .dot { width: 8px; height: 8px; }
  }

  @media (max-width: 480px) {
    .projects-carousel { padding: 80px 0; }
    .container-parcours { padding: 0 20px; }
    .header-projects { margin-bottom: 60px; }
    .projects-slider { height: 320px; }
    .carousel-item { width: calc(100vw - 40px); gap: 12px; }
    .project-card { aspect-ratio: 16 / 10; border-radius: 16px; }
    .project-video { object-fit: contain; }
    .carousel-btn { width: 36px; height: 36px; top: 140px; transform: translateY(-50%); }
    .carousel-btn.prev { left: 6px; }
    .carousel-btn.next { right: 6px; }
    .project-name { font-size: 1rem; }
    .project-desc { font-size: 0.85rem; }
    .carousel-dots { gap: 6px; margin-top: 2px; }
    .dot { width: 8px; height: 8px; }
  }
    .dot { width: 8px; height: 8px; }
    .project-name { font-size: 1rem; }
    .project-desc { font-size: 0.85rem; }
  }
</style>

<script is:inline>
  function initCarousel() {
    const slider = document.querySelector('.projects-slider');
    const prevBtn = document.querySelector('.carousel-btn.prev');
    const nextBtn = document.querySelector('.carousel-btn.next');
    const dots = document.querySelectorAll('.carousel-dots .dot');
    const items = Array.from(document.querySelectorAll('.carousel-item'));
    if (!slider || !items.length) return;

    let currentIndex = 0;
    const loadedVideos = new Set();

    function loadVideo(index) {
      if (loadedVideos.has(index)) return;
      const item = items[index];
      if (!item) return;
      const video = item.querySelector('.project-video');
      if (!video || !video.dataset.src) return;
      console.log('Loading video:', video.dataset.src);
      video.src = video.dataset.src;
      video.load();
      loadedVideos.add(index);
      video.addEventListener('loadeddata', () => console.log('Video loaded:', video.dataset.src));
      video.addEventListener('error', (e) => console.error('Video error:', video.dataset.src, e));
    }

    function playActiveVideo() {
      items.forEach((item, idx) => {
        const video = item.querySelector('.project-video');
        if (!video) return;
        if (idx === currentIndex && item.classList.contains('is-active')) {
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      });
    }

    function applyPositions() {
      items.forEach((item, idx) => {
        item.classList.remove('is-active','is-right','is-left');
        const offset = idx - currentIndex;
        if (offset === 0) {
          item.classList.add('is-active');
        } else if (offset > 0) {
          item.classList.add('is-right');
          item.style.setProperty('--idx', String(Math.min(offset, 3)));
        } else {
          item.classList.add('is-left');
        }
      });
      dots.forEach((dot, i) => dot.classList.toggle('active', i === currentIndex));
      
      loadVideo(currentIndex);
      if (currentIndex + 1 < items.length) loadVideo(currentIndex + 1);
      
      setTimeout(playActiveVideo, 100);
    }

    function next() { currentIndex = Math.min(currentIndex + 1, items.length - 1); applyPositions(); }
    function prev() { currentIndex = Math.max(currentIndex - 1, 0); applyPositions(); }

    prevBtn?.addEventListener('click', prev);
    nextBtn?.addEventListener('click', next);
    dots.forEach((dot, idx) => { dot.addEventListener('click', () => { currentIndex = idx; applyPositions(); }); });

    let startX = 0; let tracking = false;
    slider.addEventListener('pointerdown', (e) => { tracking = true; startX = e.clientX; slider.setPointerCapture(e.pointerId); });
    slider.addEventListener('pointerup', (e) => { if (!tracking) return; const dx = e.clientX - startX; if (dx < -40) next(); else if (dx > 40) prev(); tracking = false; });
    slider.addEventListener('pointercancel', () => { tracking = false; });

    applyPositions();
  }

  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initCarousel); } else { initCarousel(); }
</script>