---
const services = [
  { id: "seo", title: "SEO", subtitle: "Visibilité organique durable", icon: "search", benefits: [
    "Audit SEO complet : état des lieux technique et analyse de votre positionnement en ligne",
    "Stratégie de contenu : mots-clés ciblés pour votre secteur et zone géographique",
    "Optimisation technique : site rapide, bien structuré et facilement indexé par Google",
    "Suivi de performance : rapports mensuels avec positions, trafic et actions concrètes"
  ]},
  { id: "sea", title: "SEA", subtitle: "Google Ads & Retargeting", icon: "target", benefits: [
    "Campagnes rentables : budget optimisé pour maximiser vos conversions",
    "Ciblage précis : touchez vos clients idéaux au bon moment",
    "Retargeting intelligent : relancez les visiteurs intéressés pour les convertir en clients",
    "Reporting transparent : ROI clair sur chaque euro investi"
  ]},
  { id: "web", title: "Création de site web 100% codé", subtitle: "Sur-mesure, rapide, optimisé", icon: "code", benefits: [
    "Performance & UX : chargement rapide, navigation fluide et expérience utilisateur optimisée sur tous les appareils",
    "Design unique : aucun template, votre identité est respectée à 100%",
    "SEO natif : optimisation structurelle pour Google dès la première ligne de code",
    "Maintenance assurée : mises à jour gérées par nos soins, sérénité totale"
  ]},
  { id: "analytics", title: "Analytics & Data", subtitle: "Mesure et optimisation", icon: "chart", benefits: [
    "Définition d'objectifs : mise en place d'indicateurs clés alignés avec votre business",
    "Analyse de performance : décryptage de vos résultats et pistes d'amélioration concrètes",
    "Tracking précis : comprenez le parcours complet de vos visiteurs sur le web",
    "Optimisation continue : tests et ajustements réguliers pour améliorer vos résultats"
  ]},
  { id: "conseil", title: "Conseil Marketing & Commercial", subtitle: "Stratégie & accompagnement", icon: "spark", benefits: [
    "Audit marketing : analyse de votre positionnement et opportunités de croissance",
    "Stratégie commerciale : parcours client optimisé de la découverte à la conversion",
    "Plan d'action sur-mesure : stratégie digitale adaptée à votre budget et vos ambitions",
    "Suivi de résultats : pilotage des performances et recommandations d'amélioration"
  ]}
];

const getIcon = (type: string) => {
  const icons = {
    code: `<path d="M16 18L22 12L16 6"/><path d="M8 6L2 12L8 18"/>`,
    search: `<circle cx="11" cy="11" r="8"/><path d="M21 21L16.65 16.65"/>`,
    target: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>`,
    spark: `<path d="M12 2L15 8.5L22 9L17 14L18 21L12 17.5L6 21L7 14L2 9L9 8.5L12 2Z"/>`,
    chart: `<path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>`
  };
  return icons[type] || icons.spark;
};
---

<section class="services" id="solutions" aria-label="Nos prestations">
  <div class="container-services">
    <div class="header-services">
      <h2>Ce qu'on fait vraiment bien</h2>
      <p class="intro">Des prestations concrètes qui génèrent des résultats mesurables pour votre entreprise.</p>
    </div>

    <div class="carousel-wrapper" data-carousel>
      <div class="carousel-viewport">
        <div class="carousel-track" role="list">
          {services.map((service, index) => (
            <div class="carousel-slide" data-index={index} data-id={service.id} role="listitem" tabindex="0" aria-selected="false">
              <div class="service-card glass">
                <div class="icon-wrapper">
                  <svg class="service-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <Fragment set:html={getIcon(service.icon)} />
                  </svg>
                </div>
                <div class="service-content">
                  <h3>{service.title}</h3>
                  <p class="subtitle">{service.subtitle}</p>
                  <ul class="benefits-list">
                    {service.benefits.map((benefit) => (
                      <li>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12L10 17L20 7"/></svg>
                        <span set:html={benefit.replace(/^([^:]+:)/, '<strong>$1</strong>')} />
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
      
      <a href="/nos-solutions" class="carousel-edge-cta carousel-edge-cta-left" data-edge-cta="left">
        <span class="edge-cta-text">Découvrir plus amplement nos solutions</span>
      </a>
      
      <a href="/nos-solutions" class="carousel-edge-cta carousel-edge-cta-right" data-edge-cta="right">
        <span class="edge-cta-text">Découvrir plus amplement nos solutions</span>
      </a>
      
      <div class="carousel-hint">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        <span class="hint-desktop">Cliquez sur les cartes pour explorer</span>
        <span class="hint-mobile">Glissez pour explorer</span>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      </div>
    </div>
  </div>
</section>

<style>
  .services{position:relative;padding:120px 0;overflow:hidden;z-index:1}
  .container-services{
    max-width:1380px;
    margin:0 auto;
    padding:0 32px;
    opacity:0;
    transform:translateY(30px);
  }

  @keyframes sectionFadeIn{
    from{opacity:0;transform:translateY(30px)}
    to{opacity:1;transform:translateY(0)}
  }

  .header-services{text-align:center;max-width:680px;margin:0 auto 35px}
  .header-services h2{
    font-size:clamp(2rem,3.5vw,3rem);
    margin:0 0 16px;
    background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,.85) 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text
  }
  .intro{font-size:1.15rem;color:var(--kano-light);opacity:.88;line-height:1.6;margin:0}

  .carousel-wrapper{
    position:relative;
    width:100%;
    max-width:1200px;
    margin:0 auto;
    padding:60px 0;
    perspective:1400px
  }

  .carousel-slide{
    position:absolute;
    left:0;
    width:440px;
    height:580px;
    outline:none;
    transform-style:preserve-3d;
    transition:transform .6s cubic-bezier(.22,.61,.36,1),opacity .6s cubic-bezier(.22,.61,.36,1),filter .6s cubic-bezier(.22,.61,.36,1);
    will-change:transform,opacity,filter;
    cursor:pointer;
    opacity:0;
  }

  @keyframes cardFadeIn{
    0%{opacity:0}
    100%{opacity:1}
  }

  .carousel-slide[aria-selected="true"]{cursor:default}

  .carousel-edge-cta{
    position:absolute;
    top:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    opacity:0;
    pointer-events:none;
    transition:all .35s cubic-bezier(.22,.61,.36,1) .35s;
    z-index:200;
    padding:20px 28px;
    border-radius:14px;
    background:rgba(255,255,255,.08);
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    border:1px solid rgba(212,175,55,.25);
    box-shadow:0 8px 32px rgba(0,0,0,.3);
    max-width:260px;
  }
  .carousel-edge-cta-left{
    left:60px;
    transform:translate(-40px, -50%)
  }
  .carousel-edge-cta-right{
    right:60px;
    transform:translate(40px, -50%)
  }
  .carousel-edge-cta.visible{
    opacity:.85;
    pointer-events:auto
  }
  .carousel-edge-cta:not(.visible){
    transition:all .15s ease-out
  }
  .carousel-edge-cta-left.visible{
    transform:translate(0, -50%)
  }
  .carousel-edge-cta-right.visible{
    transform:translate(0, -50%)
  }
  .carousel-edge-cta:hover{
    opacity:1;
    border-color:rgba(212,175,55,.4);
    box-shadow:0 12px 40px rgba(0,0,0,.4)
  }
  .carousel-edge-cta-left:hover{
    transform:translate(-2px, -50%)
  }
  .carousel-edge-cta-right:hover{
    transform:translate(2px, -50%)
  }
  .edge-cta-text{font-size:1.05rem;font-weight:600;color:var(--kano-gold);text-align:center;line-height:1.5}

  .carousel-viewport{position:relative;height:600px;overflow:visible}
  .carousel-track{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:flex;
    justify-content:center;
    align-items:center;
    transition:none
  }

  .service-card{
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    padding:36px 32px;
    box-shadow:0 20px 60px rgba(0,0,0,.4);
    transition:box-shadow .3s ease
  }
  .carousel-slide:hover .service-card{box-shadow:0 24px 70px rgba(0,0,0,.5)}

  .icon-wrapper{
    width:72px;
    height:72px;
    border-radius:18px;
    background:linear-gradient(135deg,rgba(212,175,55,.2),rgba(212,175,55,.08));
    border:1px solid rgba(212,175,55,.4);
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 auto 24px
  }
  .service-icon{color:var(--kano-gold);transition:transform .35s cubic-bezier(.34,1.56,.64,1)}
  .carousel-slide:hover .service-icon{transform:scale(1.04) rotate(3deg)}

  .service-content{text-align:center;flex:1;display:flex;flex-direction:column}
  .service-content h3{font-size:1.5rem;font-weight:800;color:#fff;margin:0 0 10px;letter-spacing:.3px}
  .subtitle{font-size:1.05rem;color:var(--kano-light);opacity:.85;margin:0 0 28px;font-weight:500}

  .benefits-list{
    list-style:none;
    display:flex;
    flex-direction:column;
    gap:14px;
    margin:0;
    padding:0;
    text-align:left
  }
  .benefits-list li{
    display:grid;
    grid-template-columns:auto 1fr;
    gap:12px;
    align-items:start;
    color:var(--kano-light);
    font-size:.95rem;
    line-height:1.55;
    opacity:.9
  }
  .benefits-list svg{color:var(--kano-gold);margin-top:2px;flex-shrink:0}
  .benefits-list strong{font-weight:600;color:#fff}

  .carousel-hint{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    margin-top:32px;
    color:var(--kano-light);
    opacity:.6;
    font-size:.9rem
  }
  .carousel-hint svg{color:var(--kano-gold);animation:slideHint 2s ease-in-out infinite}
  .carousel-hint svg:first-child{animation-delay:0s}
  .carousel-hint svg:last-child{animation-delay:1s}
  .hint-mobile{display:none}

  @keyframes slideHint{
    0%,100%{transform:translateX(0);opacity:.6}
    50%{transform:translateX(-4px);opacity:1}
  }

  @keyframes ctaFadeIn{
    0%{opacity:0;transform:translateY(-20px)}
    100%{opacity:.85;transform:translateY(0)}
  }

  .services.services-visible .container-services{
    animation:sectionFadeIn .9s ease-out forwards;
  }
  .services.services-visible .carousel-slide{
    animation:cardFadeIn .9s cubic-bezier(.22,.61,.36,1) backwards;
  }
  .services.services-visible .carousel-slide:nth-child(1){animation-delay:.15s}
  .services.services-visible .carousel-slide:nth-child(2){animation-delay:.25s}
  .services.services-visible .carousel-slide:nth-child(3){animation-delay:.35s}
  .services.services-visible .carousel-slide:nth-child(4){animation-delay:.45s}
  .services.services-visible .carousel-slide:nth-child(5){animation-delay:.55s}

  @media (min-width:769px) and (max-width:1024px){
    .carousel-slide{width:380px;height:540px;cursor:default}
    .service-card{padding:32px 28px}

    .carousel-wrapper{
      padding:40px 0 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .carousel-viewport{order:1;height:550px;overflow:visible}
    .carousel-edge-cta{
      order:2;
      display:none;
      position:static;
      transform:none !important;
      max-width:90%;
      margin:0 auto;
      padding:20px 16px;
      left:auto;
      right:auto;
      transition:opacity .3s ease-out,transform .3s ease-out;
    }
    .carousel-hint{
      order:3;
      margin-top:0;
      font-size:1.05rem;
      opacity:.8;
      transform:translateY(20px);
      transition:transform .6s cubic-bezier(.34,.46,.35,1);
    }
    .carousel-wrapper.carousel-wrapper--cta-visible .carousel-hint{
      transform:translateY(15px);
    }
    .carousel-edge-cta.visible{
      display:flex;
      opacity:0;
      pointer-events:auto;
      transform:translateY(0) !important;
      animation:ctaFadeIn .4s cubic-bezier(.22,.61,.36,1) .3s forwards;
    }
    .carousel-edge-cta:not(.visible){
      opacity:0;
      transform:translateY(-20px) !important;
      transition:opacity .25s ease-out,transform .25s ease-out;
    }
    .edge-cta-text{font-size:.95rem}
    .hint-desktop{display:none}
    .hint-mobile{display:inline}
  }

  @media (max-width:768px){
    .services{padding:80px 0}
    .container-services{padding:0 20px}
    .header-services{margin-bottom:5px}
    .carousel-slide{width:min(340px,85vw);height:540px;cursor:default}
    .service-card{padding:28px 24px}
    .icon-wrapper{width:64px;height:64px}
    
    .carousel-wrapper{
      gap:4px;
      padding:40px 0 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .carousel-viewport{order:1;height:550px;overflow:visible}
    .carousel-edge-cta{
      order:2;
      display:none;
      position:static;
      transform:none !important;
      max-width:100%;
      margin:0 auto;
      padding:18px 14px;
      left:auto;
      right:auto;
      transition:opacity .3s ease-out,transform .3s ease-out;
    }
    .carousel-hint{
      order:3;
      margin-top:0;
      font-size:1rem;
      transform:translateY(15px);
      transition:transform .6s cubic-bezier(.34,.46,.35,1);
    }
    .carousel-wrapper.carousel-wrapper--cta-visible .carousel-hint{
      transform:translateY(20px);
    }
    .carousel-edge-cta.visible{
      display:flex;
      opacity:0;
      pointer-events:auto;
      transform:translateY(0) !important;
      animation:ctaFadeIn .4s cubic-bezier(.22,.61,.36,1) .3s forwards;
    }
    .carousel-edge-cta:not(.visible){
      opacity:0;
      transform:translateY(-20px) !important;
      transition:opacity .25s ease-out,transform .25s ease-out;
    }
    .edge-cta-text{font-size:.9rem}
    .hint-desktop{display:none}
    .hint-mobile{display:inline}
    .service-content h3{font-size:1.3rem}
    .carousel-slide[aria-selected="true"] .service-content h3{font-size:1.45rem}
    .subtitle{font-size:.98rem;margin-bottom:22px}
    .carousel-slide[aria-selected="true"] .subtitle{font-size:1.05rem}
    .benefits-list{gap:12px}
    .benefits-list li{font-size:.9rem}
    .carousel-slide[aria-selected="true"] .benefits-list li{font-size:.95rem}
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const servicesSection = document.querySelector('.services');
  const viewport = document.querySelector('.carousel-viewport');
  const track = document.querySelector('.carousel-track');
  const slides = [...document.querySelectorAll('.carousel-slide')];
  const leftCta = document.querySelector('[data-edge-cta="left"]');
  const rightCta = document.querySelector('[data-edge-cta="right"]');
  
  if (!viewport || !track || slides.length === 0) return;

  if (servicesSection) {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          servicesSection.classList.add('services-visible');
          obs.disconnect();
        }
      });
    }, { threshold: 0.15 });
    observer.observe(servicesSection);
  }

  const totalSlides = slides.length;
  let CARD_WIDTH = 440;
  let GAP = 32;
  
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  const isTablet = window.matchMedia('(min-width: 769px) and (max-width: 1024px)').matches;
  
  if (isMobile) {
    CARD_WIDTH = Math.min(340, window.innerWidth * 0.75);
    GAP = 20;
  } else if (isTablet) {
    CARD_WIDTH = 380;
    GAP = 28;
  }

  let currentIndex = 2;
  let isDragging = false;
  let startX = 0;
  let startY = 0;
  let currentX = 0;
  let dragDirection = null;

  const isTouch = 'ontouchstart' in window;

  function getScaleForDistance(distance) {
    const abs = Math.abs(distance);
    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
    const nowTablet = window.matchMedia('(min-width: 769px) and (max-width: 1024px)').matches;
    
    if (nowMobile || nowTablet) {
      if (abs === 0) return 1;
      if (abs === 1) return 0.75;
      return 0.55;
    }
    
    if (abs === 0) return 1.06;
    if (abs === 1) return 0.90;
    if (abs === 2) return 0.78;
    return 0.70;
  }

  function getOpacityForDistance(distance) {
    const abs = Math.abs(distance);
    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
    
    if (nowMobile) {
      if (abs === 0) return 1;
      if (abs === 1) return 0.5;
      return 0.2;
    }
    
    if (abs === 0) return 1;
    if (abs === 1) return 0.85;
    if (abs === 2) return 0.65;
    return 0.45;
  }

  function getBlurForDistance(distance) {
    const abs = Math.abs(distance);
    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
    
    if (nowMobile) {
      if (abs === 0) return 0;
      if (abs === 1) return 3;
      return 5;
    }
    
    if (abs === 0) return 0;
    if (abs === 1) return 1;
    if (abs === 2) return 2.5;
    return 4;
  }

  function getRotateYForDistance(distance) {
    if (distance === 0) return 0;
    return -distance * 8;
  }

  function updateEdgeCtas() {
    const wrapper = document.querySelector('.carousel-wrapper');
    const isTabletOrMobile = window.matchMedia('(max-width: 1024px)').matches;
    
    if (leftCta) {
      if (currentIndex === 0) {
        leftCta.classList.remove('hidden');
        leftCta.classList.add('visible');
        if (isTabletOrMobile && wrapper) {
          wrapper.classList.add('carousel-wrapper--cta-visible');
        }
      } else {
        leftCta.classList.remove('visible');
        leftCta.classList.add('hidden');
        if (isTabletOrMobile && wrapper && currentIndex !== totalSlides - 1) {
          wrapper.classList.remove('carousel-wrapper--cta-visible');
        }
      }
    }
    
    if (rightCta) {
      if (currentIndex === totalSlides - 1) {
        rightCta.classList.remove('hidden');
        rightCta.classList.add('visible');
        if (isTabletOrMobile && wrapper) {
          wrapper.classList.add('carousel-wrapper--cta-visible');
        }
      } else {
        rightCta.classList.remove('visible');
        rightCta.classList.add('hidden');
        if (isTabletOrMobile && wrapper && currentIndex !== 0) {
          wrapper.classList.remove('carousel-wrapper--cta-visible');
        }
      }
    }
  }

  function updateSlides(animate = true) {
    const viewportCenter = viewport.offsetWidth / 2;

    slides.forEach((slide, index) => {
      const distance = index - currentIndex;
      const scale = getScaleForDistance(distance);
      
      let cumulativeOffset = 0;
      if (distance > 0) {
        for (let i = 1; i <= distance; i++) {
          const prevScale = getScaleForDistance(i - 1);
          const currentScale = getScaleForDistance(i);
          const prevWidth = CARD_WIDTH * prevScale;
          const currentWidth = CARD_WIDTH * currentScale;
          cumulativeOffset += (prevWidth / 2) + GAP + (currentWidth / 2);
        }
      } else if (distance < 0) {
        for (let i = -1; i >= distance; i--) {
          const prevScale = getScaleForDistance(i + 1);
          const currentScale = getScaleForDistance(i);
          const prevWidth = CARD_WIDTH * prevScale;
          const currentWidth = CARD_WIDTH * currentScale;
          cumulativeOffset -= (prevWidth / 2) + GAP + (currentWidth / 2);
        }
      }

      const xPosition = viewportCenter + cumulativeOffset;
      const opacity = getOpacityForDistance(distance);
      const blur = getBlurForDistance(distance);
      const rotateY = getRotateYForDistance(distance);
      const zIndex = 100 - Math.abs(distance) * 10;

      if (!animate) {
        slide.style.transition = 'none';
      }

      slide.style.transform = `translateX(-50%) translateX(${xPosition}px) scale(${scale}) rotateY(${rotateY}deg) translateZ(0)`;
      slide.style.opacity = String(opacity);
      slide.style.filter = `blur(${blur}px)`;
      slide.style.zIndex = String(zIndex);
      slide.setAttribute('aria-selected', distance === 0 ? 'true' : 'false');

      if (!animate) {
        requestAnimationFrame(() => {
          slide.style.transition = '';
        });
      }
    });
    
    updateEdgeCtas();
  }

  function goToSlide(index, animate = true) {
    currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
    updateSlides(animate);
  }

  slides.forEach((slide, index) => {
    if (!isTouch) {
      slide.addEventListener('click', () => {
        if (index !== currentIndex) {
          goToSlide(index);
        }
      });
    }
  });

  if (isTouch) {
    track.addEventListener('touchstart', (e) => {
      isDragging = true;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      dragDirection = null;
    });

    track.addEventListener('touchmove', (e) => {
      if (!isDragging) return;

      const touchX = e.touches[0].clientX;
      const touchY = e.touches[0].clientY;
      const deltaX = touchX - startX;
      const deltaY = touchY - startY;

      if (dragDirection === null && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
        dragDirection = Math.abs(deltaX) > Math.abs(deltaY) ? 'horizontal' : 'vertical';
      }

      if (dragDirection === 'horizontal') {
        e.preventDefault();
        currentX = deltaX;
      }
    });

    track.addEventListener('touchend', () => {
      if (!isDragging) return;
      isDragging = false;

      if (dragDirection === 'horizontal') {
        const threshold = CARD_WIDTH / 4;
        
        if (currentX < -threshold && currentIndex < totalSlides - 1) {
          goToSlide(currentIndex + 1);
        } else if (currentX > threshold && currentIndex > 0) {
          goToSlide(currentIndex - 1);
        } else {
          updateSlides(true);
        }
      }

      currentX = 0;
      dragDirection = null;
    });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' && currentIndex < totalSlides - 1) {
      goToSlide(currentIndex + 1);
    } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
      goToSlide(currentIndex - 1);
    }
  });

  goToSlide(currentIndex, false);

  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      const nowMobile = window.matchMedia('(max-width: 768px)').matches;
      const nowTablet = window.matchMedia('(min-width: 769px) and (max-width: 1024px)').matches;
      
      if (nowMobile) {
        CARD_WIDTH = Math.min(340, window.innerWidth * 0.75);
        GAP = 20;
      } else if (nowTablet) {
        CARD_WIDTH = 380;
        GAP = 28;
      } else {
        CARD_WIDTH = 440;
        GAP = 32;
      }
      
      goToSlide(currentIndex, false);
    }, 100);
  });
});
</script>