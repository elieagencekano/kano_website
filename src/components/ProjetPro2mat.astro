---
const projet = {
  titre: "PRO2MAT",
  sousTitre: "Matériel de levage près d'Angers",
  
  imageFront: "pro2matcard.webp",
  videoBack: "pro2matmockupmacbook.mp4",
  altFront: "Pro2Mat - Carte",
  altBack: "Pro2Mat - Mockup",
  
  smallCards: [
    {
      type: "video",
      src: "pro2matmockupiphoneblog.mp4",
      alt: "Pro2Mat - Mockup Blog"
    },
    {
      type: "video",
      src: "pro2matmockupproductpage.mp4",
      alt: "Pro2Mat - Mockup Page Produit"
    }
  ],
  
  descriptionTitre: "Un site qui perdait ses visiteurs",
  descriptionParagraphes: [
    "PRO2MAT disposait d'un site construit sur un <strong>template e-commerce inadapté</strong> à son activité. Résultat : des boutons \"Ajouter au panier\" sur des produits sans prix, une navigation confuse et des visiteurs qui repartaient sans comprendre comment contacter l'entreprise. Le site générait à peine <strong>4 demandes par mois</strong>."
  ],
  descriptionTitre2: "Une refonte pensée pour convertir",
  descriptionParagraphes2: [
    "Nous avons entièrement repensé l'expérience utilisateur avec des <strong>pages produits optimisées</strong> qui guident vers la demande de devis ou d'essai. Chaque parcours mène naturellement vers le <strong>formulaire de contact</strong>. Un <strong>blog SEO</strong> avec des articles réguliers sur le levage renforce la visibilité. Résultat : PRO2MAT reçoit désormais <strong>4 à 5 demandes par semaine</strong>."
  ],
  lienSite: "https://pro2mat.fr",
  lienTexte: "Découvrir le site de PRO2MAT"
};
---

<section class="projet-pro2mat" aria-label="Projet Pro2Mat">
  <div class="container">
    <div class="cards-wrapper">
      <div class="main-card">
        <div class="card-inner">
          <div class="card-front">
            <img src={`${import.meta.env.BASE_URL}${projet.imageFront}`} alt={projet.altFront} />
            <div class="card-overlay">
              <div class="card-titles">
                <span class="card-subtitle">{projet.sousTitre}</span>
                <h2>{projet.titre}</h2>
              </div>
            </div>
          </div>
          <div class="card-back">
            <video 
              id="video-back-pro2mat" 
              src={`${import.meta.env.BASE_URL}${projet.videoBack}`} 
              muted 
              playsinline
              preload="auto"
            ></video>
          </div>
        </div>
      </div>
      
      <div class="small-cards">
        {projet.smallCards.map((card, index) => (
          <div class="small-card">
            {card.type === "video" ? (
              <video 
                id={`video-small-pro2mat-${index}`}
                src={`${import.meta.env.BASE_URL}${card.src}`} 
                muted 
                playsinline
                preload="auto"
              ></video>
            ) : (
              <img src={`${import.meta.env.BASE_URL}${card.src}`} alt={card.alt} />
            )}
          </div>
        ))}
      </div>
      
      <div class="project-description">
        <h3>{projet.descriptionTitre}</h3>
        {projet.descriptionParagraphes.map((paragraphe) => (
          <p set:html={paragraphe}></p>
        ))}
        <h3>{projet.descriptionTitre2}</h3>
        {projet.descriptionParagraphes2.map((paragraphe) => (
          <p set:html={paragraphe}></p>
        ))}
        <a href={projet.lienSite} target="_blank" rel="noopener noreferrer" class="project-link">{projet.lienTexte}</a>
      </div>
      
      <div class="cta-section">
        <h3>Votre site mérite mieux</h3>
        <p>Vous aussi, vous perdez des clients à cause d'un site inadapté ? Discutons de votre projet et trouvons ensemble la solution pour transformer vos visiteurs en clients.</p>
        <a href="/contact" class="cta-button">
          <span>Discuter de mon projet</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</section>

<style>
.projet-pro2mat{position:relative;min-height:260vh;padding:60px 0}
.container{max-width:1000px;margin:0 auto;padding:0 32px;position:sticky;top:80px}
.cards-wrapper{position:relative;perspective:1500px}
.main-card{width:100%;aspect-ratio:16/10;position:relative;transform-style:preserve-3d;overflow:visible}
.card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;will-change:transform}
.card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.card-front img,.card-back img,.card-back video{width:100%;height:100%;object-fit:cover;object-position:center}
.card-back{transform:rotateY(180deg)}
.card-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
.card-titles{display:flex;flex-direction:column;align-items:center;gap:12px}
.card-subtitle{font-family:Montserrat,sans-serif;font-size:clamp(.75rem,1.5vw,1rem);font-weight:500;color:var(--kano-gold);text-transform:uppercase;letter-spacing:3px}
.card-overlay h2{font-family:Montserrat,sans-serif;font-size:clamp(1.8rem,4vw,3rem);font-weight:900;color:#fff;text-align:center;margin:0;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,.85) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.small-cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;opacity:0;transform:translateY(-200px);z-index:-1;position:relative;will-change:transform,opacity;transition:none}
.small-card{border-radius:16px;overflow:hidden;box-shadow:0 15px 40px rgba(0,0,0,.3);aspect-ratio:4/3}
.small-card img,.small-card video{width:100%;height:100%;object-fit:cover;object-position:center}
.main-card.flipped .card-inner{transform:rotateY(180deg)}
.small-cards.revealed{opacity:1;transform:translateY(0)}
.project-description{margin-top:30px;padding:20px 0;opacity:0;transform:translateY(30px);will-change:transform,opacity}
.project-description h3{font-family:Montserrat,sans-serif;font-size:1.3rem;font-weight:700;color:#fff;margin:0 0 16px 0}
.project-description h3:not(:first-child){margin-top:24px}
.project-description p{font-size:.9rem;color:var(--kano-light);opacity:.8;line-height:1.5;margin:0 0 15px 0}
.project-description p:last-of-type{margin-bottom:0}
.project-link{display:inline-block;margin-top:20px;font-family:Montserrat,sans-serif;font-size:.9rem;font-weight:600;color:var(--kano-gold);text-decoration:none;transition:opacity .3s ease}
.project-link:hover{opacity:.7}
.cta-section{margin-top:40px;padding:40px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 20px 60px rgba(0,0,0,.4);border-radius:24px;text-align:center;opacity:0;transform:translateY(30px);will-change:transform,opacity}
.cta-section h3{font-family:Montserrat,sans-serif;font-size:1.5rem;font-weight:800;color:#fff;margin:0 0 16px 0}
.cta-section p{font-size:1rem;color:var(--kano-light);opacity:.88;line-height:1.6;margin:0 0 24px 0;max-width:500px;margin-left:auto;margin-right:auto}
.cta-button{display:inline-flex;align-items:center;gap:10px;padding:18px 36px;border-radius:999px;background:var(--kano-gold);color:var(--kano-ink);font-family:Montserrat,sans-serif;font-weight:700;font-size:1.08rem;text-decoration:none;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 8px 26px rgba(212,175,55,.3)}
.cta-button:hover{transform:translateY(-3px);box-shadow:0 12px 32px rgba(212,175,55,.45)}

@media (max-width:768px){
  .projet-pro2mat{padding:40px 0;min-height:300vh}
  .container{padding:0 20px;top:80px}
  .small-cards{gap:12px;margin-top:12px}
  .small-card{aspect-ratio:3/4}
  .small-card img,.small-card video{object-fit:cover;object-position:center}
  .card-overlay h2{font-size:1.5rem}
  .card-subtitle{font-size:.7rem;letter-spacing:2px}
  .card-titles{gap:8px}
  .project-description{margin-top:20px;padding:15px 0}
  .project-description h3{font-size:1.1rem;margin-bottom:12px}
  .project-description p{font-size:.85rem}
  .cta-section{margin-top:30px;padding:28px 20px}
  .cta-section h3{font-size:1.3rem}
  .cta-section p{font-size:.9rem}
  .cta-button{padding:16px 28px;font-size:1rem}
}
@media (max-width:480px){
  .container{top:70px}
  .card-overlay h2{font-size:1.3rem}
  .card-subtitle{font-size:.65rem}
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.querySelector('.projet-pro2mat');
  const cardInner = section ? section.querySelector('.card-inner') : null;
  const smallCards = section ? section.querySelector('.small-cards') : null;
  const projectDescription = section ? section.querySelector('.project-description') : null;
  const videoBack = document.getElementById('video-back-pro2mat');
  const videoSmall = document.getElementById('video-small-pro2mat-0');
  const videoSmall2 = document.getElementById('video-small-pro2mat-1');
  const ctaSection = section ? section.querySelector('.cta-section') : null;

  if (!section || !cardInner || !smallCards) return;

  let viewportHeight = window.innerHeight;
  let viewportWidth = window.innerWidth;
  let isMobile = viewportWidth <= 1024;
  let sectionOffsetTop = section.offsetTop;

  let videoBackPlayed = false;
  let videoSmallPlayed = false;
  let videoSmall2Played = false;
  let lastScrollY = window.scrollY || window.pageYOffset || 0;
  let scrollDirection = 'down';

  const onResize = () => {
    viewportHeight = window.innerHeight;
    viewportWidth = window.innerWidth;
    isMobile = viewportWidth <= 1024;
    sectionOffsetTop = section.offsetTop;
  };

  window.addEventListener('resize', onResize);

  let targetScroll = window.scrollY || window.pageYOffset || 0;
  let virtualScroll = targetScroll;

  const easeInOutCubic = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
  const clamp01 = v => Math.max(0, Math.min(1, v));

  const reverseVideo = (video) => {
    if (!video || video.currentTime <= 0) return;
    const reverseStep = () => {
      if (scrollDirection === 'up' && video.currentTime > 0) {
        video.currentTime = Math.max(0, video.currentTime - 0.05);
        requestAnimationFrame(reverseStep);
      }
    };
    requestAnimationFrame(reverseStep);
  };

  const updateWithScroll = () => {
    const sectionTop = sectionOffsetTop - virtualScroll;

    if (isMobile && virtualScroll < 80) {
      cardInner.style.transform = 'rotateY(0deg)';
      smallCards.style.opacity = '0';
      smallCards.style.transform = 'translateY(-200px)';
      if (projectDescription) {
        projectDescription.style.opacity = '0';
        projectDescription.style.transform = 'translateY(30px)';
      }
      if (ctaSection) {
        ctaSection.style.opacity = '0';
        ctaSection.style.transform = 'translateY(30px)';
      }
      return;
    }

    const startThreshold = isMobile ? viewportHeight * 0.8 : viewportHeight * 0.5;
    const endThreshold   = isMobile ? -viewportHeight * 0.8 : -viewportHeight * 0.9;

    if (sectionTop > startThreshold) {
      cardInner.style.transform = 'rotateY(0deg)';
      smallCards.style.opacity = '0';
      smallCards.style.transform = 'translateY(-200px)';
      if (projectDescription) {
        projectDescription.style.opacity = '0';
        projectDescription.style.transform = 'translateY(30px)';
      }
      if (ctaSection) {
        ctaSection.style.opacity = '0';
        ctaSection.style.transform = 'translateY(30px)';
      }
      videoBackPlayed = false;
      videoSmallPlayed = false;
      videoSmall2Played = false;
      if (videoBack) {
        videoBack.currentTime = 0;
        videoBack.pause();
      }
      if (videoSmall) {
        videoSmall.currentTime = 0;
        videoSmall.pause();
      }
      if (videoSmall2) {
        videoSmall2.currentTime = 0;
        videoSmall2.pause();
      }
      return;
    }

    const scrolledAmount = startThreshold - sectionTop;
    const scrollRange    = startThreshold - endThreshold;

    const base = clamp01(scrolledAmount / scrollRange);
    let rawProgress;

    if (isMobile) {
      const delayed = (base - 0.25) / 0.75;
      rawProgress = clamp01(delayed);
    } else {
      rawProgress = base;
    }

    const scrollProgress = easeInOutCubic(rawProgress);

    let flipProgress;
    if (isMobile) {
      flipProgress = scrollProgress;
    } else {
      flipProgress = clamp01(scrollProgress / 0.5);
    }

    const flipAngle = flipProgress * 180;
    cardInner.style.transform = `rotateY(${flipAngle}deg)`;

    if (videoBack && flipAngle >= 90 && !videoBackPlayed && scrollDirection === 'down') {
      videoBackPlayed = true;
      videoBack.play();
    }

    if (videoBack && flipAngle < 90 && videoBackPlayed && scrollDirection === 'up') {
      videoBackPlayed = false;
      videoBack.pause();
      reverseVideo(videoBack);
    }

    const cardsStart   = scrollRange * 0.25;
    const cardsEnd     = scrollRange * 0.8;
    const cardsRaw     = (scrolledAmount - cardsStart) / (cardsEnd - cardsStart);
    const cardsClamped = clamp01(cardsRaw);
    const easedCards   = easeInOutCubic(cardsClamped);
    const cardsY       = 200 - easedCards * 200;
    const cardsOpacity = easedCards;
    smallCards.style.opacity = String(cardsOpacity);
    smallCards.style.transform = `translateY(-${cardsY}px)`;

    if (videoSmall && easedCards >= 0.6 && !videoSmallPlayed && scrollDirection === 'down') {
      videoSmallPlayed = true;
      videoSmall.play();
    }

    if (videoSmall && easedCards < 0.3 && videoSmallPlayed && scrollDirection === 'up') {
      videoSmallPlayed = false;
      videoSmall.pause();
      reverseVideo(videoSmall);
    }

    if (videoSmall2 && easedCards >= 0.6 && !videoSmall2Played && scrollDirection === 'down') {
      videoSmall2Played = true;
      videoSmall2.play();
    }

    if (videoSmall2 && easedCards < 0.3 && videoSmall2Played && scrollDirection === 'up') {
      videoSmall2Played = false;
      videoSmall2.pause();
      reverseVideo(videoSmall2);
    }

    if (projectDescription) {
      const descStart = scrollRange * 0.5;
      const descEnd = scrollRange * 0.95;
      const descRaw = (scrolledAmount - descStart) / (descEnd - descStart);
      const descClamped = clamp01(descRaw);
      const easedDesc = easeInOutCubic(descClamped);
      projectDescription.style.opacity = String(easedDesc);
      projectDescription.style.transform = `translateY(${30 - easedDesc * 30}px)`;
    }

    if (ctaSection) {
      const ctaStart = scrollRange * 0.85;
      const ctaEnd = scrollRange * 1.15;
      const ctaRaw = (scrolledAmount - ctaStart) / (ctaEnd - ctaStart);
      const ctaClamped = clamp01(ctaRaw);
      const easedCta = easeInOutCubic(ctaClamped);
      ctaSection.style.opacity = String(easedCta);
      ctaSection.style.transform = `translateY(${30 - easedCta * 30}px)`;
    }
  };

  const animate = () => {
    const factor = isMobile ? 0.12 : 0.025;
    virtualScroll += (targetScroll - virtualScroll) * factor;
    updateWithScroll();
    requestAnimationFrame(animate);
  };

  window.addEventListener('scroll', () => {
    const currentScroll = window.scrollY || window.pageYOffset || 0;
    scrollDirection = currentScroll > lastScrollY ? 'down' : 'up';
    lastScrollY = currentScroll;
    targetScroll = currentScroll;
  }, { passive: true });

  cardInner.style.transition = 'none';
  smallCards.style.transition = 'none';
  if (projectDescription) projectDescription.style.transition = 'none';
  if (ctaSection) ctaSection.style.transition = 'none';

  requestAnimationFrame(animate);
});
</script>