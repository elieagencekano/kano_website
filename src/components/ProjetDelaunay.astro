---
const projet = {
  titre: "Domaine DELAUNAY",
  sousTitre: "Viticulteur en Anjou",
  
  imageFront: "delaunaycardsection.jpg",
  videoBack: "delaunaymockupmackbook.mp4",
  altFront: "Domaine Delaunay - Grappe de raisin",
  altBack: "Domaine Delaunay - Mockup",
  
  smallCards: [
    {
      type: "video",
      src: "delaunaymockupiphone.mp4",
      alt: "Domaine Delaunay - Mockup vidéo"
    },
    {
      type: "video",
      src: "delaunaymockupiphone2.mp4",
      alt: "Domaine Delaunay - Mockup vidéo 2"
    }
  ],
  
  descriptionTitre: "Site vitrine premium",
  descriptionParagraphes: [
    "Le Domaine Didier Delaunay, viticulteur passionné en Anjou, nous a confié la refonte complète de son site vitrine. L'objectif était de créer une expérience digitale à la hauteur de ses vins d'exception, mêlant tradition et modernité.",
    "Nous avons conçu un design épuré mettant en valeur les vignobles et le terroir angevin, avec une navigation fluide permettant aux visiteurs de découvrir les différentes cuvées, l'histoire du domaine et les modalités de dégustation. Le site intègre également un système de prise de rendez-vous pour les visites au caveau."
  ]
};
---

<section class="projet-delaunay" aria-label="Projet Domaine Delaunay">
  <div class="container">
    <div class="cards-wrapper">
      <div class="main-card">
        <div class="card-inner">
          <div class="card-front">
            <img src={`${import.meta.env.BASE_URL}${projet.imageFront}`} alt={projet.altFront} />
            <div class="card-overlay">
              <div class="card-titles">
                <span class="card-subtitle">{projet.sousTitre}</span>
                <h2>{projet.titre}</h2>
              </div>
            </div>
          </div>
          <div class="card-back">
            <video 
              id="video-back" 
              src={`${import.meta.env.BASE_URL}${projet.videoBack}`} 
              muted 
              playsinline
              preload="auto"
            ></video>
          </div>
        </div>
      </div>
      
      <div class="small-cards">
        {projet.smallCards.map((card, index) => (
          <div class="small-card">
            {card.type === "video" ? (
              <video 
                id={`video-small-${index}`}
                src={`${import.meta.env.BASE_URL}${card.src}`} 
                muted 
                playsinline
                preload="auto"
              ></video>
            ) : (
              <img src={`${import.meta.env.BASE_URL}${card.src}`} alt={card.alt} />
            )}
          </div>
        ))}
      </div>
      
      <div class="project-description">
        <h3>{projet.descriptionTitre}</h3>
        {projet.descriptionParagraphes.map((paragraphe) => (
          <p>{paragraphe}</p>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
.projet-delaunay{position:relative;min-height:180vh;padding:60px 0}
.container{max-width:1000px;margin:0 auto;padding:0 32px;position:sticky;top:80px}
.cards-wrapper{position:relative;perspective:1500px}
.main-card{width:100%;aspect-ratio:16/10;position:relative;transform-style:preserve-3d}
.card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;will-change:transform}
.card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.card-front img,.card-back img,.card-back video{width:100%;height:100%;object-fit:cover;object-position:center}
.card-back{transform:rotateY(180deg)}
.card-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
.card-titles{display:flex;flex-direction:column;align-items:center;gap:12px}
.card-subtitle{font-family:Montserrat,sans-serif;font-size:clamp(.75rem,1.5vw,1rem);font-weight:500;color:var(--kano-gold);text-transform:uppercase;letter-spacing:3px}
.card-overlay h2{font-family:Montserrat,sans-serif;font-size:clamp(1.8rem,4vw,3rem);font-weight:900;color:#fff;text-align:center;margin:0;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,.85) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.small-cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;opacity:0;transform:translateY(-200px);z-index:-1;position:relative;will-change:transform,opacity;transition:none}
.small-card{border-radius:16px;overflow:hidden;box-shadow:0 15px 40px rgba(0,0,0,.3);aspect-ratio:4/3}
.small-card img,.small-card video{width:100%;height:100%;object-fit:cover;object-position:center}
.main-card.flipped .card-inner{transform:rotateY(180deg)}
.small-cards.revealed{opacity:1;transform:translateY(0)}
.project-description{margin-top:30px;padding:20px 0;opacity:0;transform:translateY(30px);will-change:transform,opacity}
.project-description h3{font-family:Montserrat,sans-serif;font-size:1.3rem;font-weight:700;color:#fff;margin:0 0 16px 0}
.project-description p{font-size:.9rem;color:var(--kano-light);opacity:.8;line-height:1.5;margin:0 0 15px 0}
.project-description p:last-child{margin-bottom:0}

@media (max-width:768px){
  .projet-delaunay{padding:40px 0;min-height:160vh}
  .container{padding:0 20px;top:80px}
  .small-cards{gap:12px;margin-top:12px}
  .card-overlay h2{font-size:1.5rem}
  .card-subtitle{font-size:.7rem;letter-spacing:2px}
  .card-titles{gap:8px}
  .project-description{margin-top:20px;padding:15px 0}
  .project-description h3{font-size:1.1rem;margin-bottom:12px}
  .project-description p{font-size:.85rem}
}
@media (max-width:480px){
  .container{top:70px}
  .card-overlay h2{font-size:1.3rem}
  .card-subtitle{font-size:.65rem}
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.querySelector('.projet-delaunay');
  const cardInner = section ? section.querySelector('.card-inner') : null;
  const smallCards = section ? section.querySelector('.small-cards') : null;
  const projectDescription = section ? section.querySelector('.project-description') : null;
  const videoBack = document.getElementById('video-back');
  const videoSmall = document.getElementById('video-small-0');
  const videoSmall2 = document.getElementById('video-small-1');

  if (!section || !cardInner || !smallCards) return;

  let viewportHeight = window.innerHeight;
  let viewportWidth = window.innerWidth;
  let isMobile = viewportWidth <= 1024;
  let sectionOffsetTop = section.offsetTop;

  let videoBackPlayed = false;
  let videoSmallPlayed = false;
  let videoSmall2Played = false;
  let lastScrollY = window.scrollY || window.pageYOffset || 0;
  let scrollDirection = 'down';

  const onResize = () => {
    viewportHeight = window.innerHeight;
    viewportWidth = window.innerWidth;
    isMobile = viewportWidth <= 1024;
    sectionOffsetTop = section.offsetTop;
  };

  window.addEventListener('resize', onResize);

  let targetScroll = window.scrollY || window.pageYOffset || 0;
  let virtualScroll = targetScroll;

  const easeInOutCubic = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
  const clamp01 = v => Math.max(0, Math.min(1, v));

  const reverseVideo = (video) => {
    if (!video || video.currentTime <= 0) return;
    const reverseStep = () => {
      if (scrollDirection === 'up' && video.currentTime > 0) {
        video.currentTime = Math.max(0, video.currentTime - 0.05);
        requestAnimationFrame(reverseStep);
      }
    };
    requestAnimationFrame(reverseStep);
  };

  const updateWithScroll = () => {
    const sectionTop = sectionOffsetTop - virtualScroll;

    if (isMobile && virtualScroll < 80) {
      cardInner.style.transform = 'rotateY(0deg)';
      smallCards.style.opacity = '0';
      smallCards.style.transform = 'translateY(-200px)';
      if (projectDescription) {
        projectDescription.style.opacity = '0';
        projectDescription.style.transform = 'translateY(30px)';
      }
      return;
    }

    const startThreshold = isMobile ? viewportHeight * 0.8 : viewportHeight * 0.35;
    const endThreshold   = isMobile ? -viewportHeight * 0.8 : -viewportHeight * 0.9;

    if (sectionTop > startThreshold) {
      cardInner.style.transform = 'rotateY(0deg)';
      smallCards.style.opacity = '0';
      smallCards.style.transform = 'translateY(-200px)';
      if (projectDescription) {
        projectDescription.style.opacity = '0';
        projectDescription.style.transform = 'translateY(30px)';
      }
      videoBackPlayed = false;
      videoSmallPlayed = false;
      videoSmall2Played = false;
      if (videoBack) {
        videoBack.currentTime = 0;
        videoBack.pause();
      }
      if (videoSmall) {
        videoSmall.currentTime = 0;
        videoSmall.pause();
      }
      if (videoSmall2) {
        videoSmall2.currentTime = 0;
        videoSmall2.pause();
      }
      return;
    }

    const scrolledAmount = startThreshold - sectionTop;
    const scrollRange    = startThreshold - endThreshold;

    const base = clamp01(scrolledAmount / scrollRange);
    let rawProgress;

    if (isMobile) {
      const delayed = (base - 0.25) / 0.75;
      rawProgress = clamp01(delayed);
    } else {
      rawProgress = base;
    }

    const scrollProgress = easeInOutCubic(rawProgress);

    let flipProgress;
    if (isMobile) {
      flipProgress = scrollProgress;
    } else {
      flipProgress = clamp01((scrollProgress - 0.05) / 0.35);
    }

    const flipAngle = flipProgress * 180;
    cardInner.style.transform = `rotateY(${flipAngle}deg)`;

    if (videoBack && flipAngle >= 90 && !videoBackPlayed && scrollDirection === 'down') {
      videoBackPlayed = true;
      videoBack.play();
    }

    if (videoBack && flipAngle < 90 && videoBackPlayed && scrollDirection === 'up') {
      videoBackPlayed = false;
      videoBack.pause();
      reverseVideo(videoBack);
    }

    const cardsStart   = scrollRange * 0.25;
    const cardsEnd     = scrollRange * 0.8;
    const cardsRaw     = (scrolledAmount - cardsStart) / (cardsEnd - cardsStart);
    const cardsClamped = clamp01(cardsRaw);
    const easedCards   = easeInOutCubic(cardsClamped);
    const cardsY       = 200 - easedCards * 200;
    const cardsOpacity = easedCards;
    smallCards.style.opacity = String(cardsOpacity);
    smallCards.style.transform = `translateY(-${cardsY}px)`;

    if (videoSmall && easedCards >= 0.6 && !videoSmallPlayed && scrollDirection === 'down') {
      videoSmallPlayed = true;
      videoSmall.play();
    }

    if (videoSmall && easedCards < 0.3 && videoSmallPlayed && scrollDirection === 'up') {
      videoSmallPlayed = false;
      videoSmall.pause();
      reverseVideo(videoSmall);
    }

    if (videoSmall2 && easedCards >= 0.6 && !videoSmall2Played && scrollDirection === 'down') {
      videoSmall2Played = true;
      videoSmall2.play();
    }

    if (videoSmall2 && easedCards < 0.3 && videoSmall2Played && scrollDirection === 'up') {
      videoSmall2Played = false;
      videoSmall2.pause();
      reverseVideo(videoSmall2);
    }

    if (projectDescription) {
      const descStart = scrollRange * 0.5;
      const descEnd = scrollRange * 0.95;
      const descRaw = (scrolledAmount - descStart) / (descEnd - descStart);
      const descClamped = clamp01(descRaw);
      const easedDesc = easeInOutCubic(descClamped);
      projectDescription.style.opacity = String(easedDesc);
      projectDescription.style.transform = `translateY(${30 - easedDesc * 30}px)`;
    }
  };

  const animate = () => {
    const factor = isMobile ? 0.12 : 0.025;
    virtualScroll += (targetScroll - virtualScroll) * factor;
    updateWithScroll();
    requestAnimationFrame(animate);
  };

  window.addEventListener('scroll', () => {
    const currentScroll = window.scrollY || window.pageYOffset || 0;
    scrollDirection = currentScroll > lastScrollY ? 'down' : 'up';
    lastScrollY = currentScroll;
    targetScroll = currentScroll;
  }, { passive: true });

  cardInner.style.transition = 'none';
  smallCards.style.transition = 'none';
  if (projectDescription) projectDescription.style.transition = 'none';

  requestAnimationFrame(animate);
});
</script>